# Copyright 2019 Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved. This file is licensed under the Apache Software License, v. 2 except as noted otherwise in the LICENSE file.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ .Values.name }}
  namespace: {{ .Release.Namespace }}
  labels:
    app: {{ .Values.name }}
    component: etcd
spec:
  updateStrategy:
    type: RollingUpdate
  serviceName: garden-etcd-{{.Values.role}}-client
  replicas: {{ .Values.replicas }}
  selector:
    matchLabels:
      app: {{ .Values.name }}
      component: etcd
  template:
    metadata:
      annotations:
        checksum/configmap-etcd-bootstrap-config: {{ include (print $.Template.BasePath "/configmap-etcd-bootstrap.yaml") . | sha256sum }}
        checksum/secret-etcd-ca: {{ include (print $.Template.BasePath "/secret-etcd-ca.yaml") . | sha256sum }}
        checksum/secret-etcd-server: {{ include (print $.Template.BasePath "/secret-etcd-server-tls.yaml") . | sha256sum }}
        checksum/secret-etcd-client: {{ include (print $.Template.BasePath "/secret-etcd-client-tls.yaml") . | sha256sum }}
        checksum/secret-etcd-backup: {{ include (print $.Template.BasePath "/secret-etcd-backup.yaml") . | sha256sum }}
{{- if .Values.podAnnotations }}
{{ toYaml .Values.podAnnotations | indent 8 }}
{{- end }}
      labels:
        app: {{ .Values.name }}
        component: etcd
    spec:
      containers:
      - name: etcd
        image: {{ index .Values.images "etcd" }}
        imagePullPolicy: IfNotPresent
        command:
        - /var/etcd/bin/bootstrap.sh
        env:
        - name: ENABLE_TLS
          value: "true"
        - name: BACKUP_ENDPOINT
          value: https://{{ .Values.name }}:8080
        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -ec
            - ETCDCTL_API=3
            - etcdctl
            - --cacert=/var/etcd/ssl/client/ca/bundle.crt
            - --cert=/var/etcd/ssl/client/client/tls.crt
            - --key=/var/etcd/ssl/client/client/tls.key
            - --endpoints=https://{{ .Values.name }}-0:2379
            - get
            - foo
            - --consistency=l
        ports:
        - containerPort: 2380
          name: serverport
          protocol: TCP
        - containerPort: 2379
          name: clientport
          protocol: TCP
        resources:
          requests:
            cpu: {{ .Values.resources.requests.cpu | default "400m" }}
            memory: {{ .Values.resources.requests.memory | default "2000Mi" }}
          limits:
            cpu: {{ .Values.resources.limits.cpu | default "1000m" }}
            memory: {{ .Values.resources.limits.memory | default "2560Mi" }}
        volumeMounts:
        - name: {{ .Values.name }}
          mountPath: /var/etcd/data
        - name: etcd-bootstrap
          mountPath: /var/etcd/config
        - name: client-url-ca-etcd
          mountPath: /var/etcd/ssl/client/ca
        - name: client-url-etcd-server-tls
          mountPath: /var/etcd/ssl/client/server
        - name: client-url-etcd-client-tls
          mountPath: /var/etcd/ssl/client/client
      - name: backup-restore
        command:
        - etcdbrctl
        - server
        - --schedule={{ .Values.backup.schedule }}
        - --max-backups={{ .Values.backup.maxBackups }}
        - --data-dir=/var/etcd/data/new.etcd
        - --storage-provider={{ .Values.backup.storageProvider }}
        - --store-prefix={{ .Values.name }}
        - --cert=/var/etcd/ssl/client/client/tls.crt
        - --key=/var/etcd/ssl/client/client/tls.key
        - --cacert=/var/etcd/ssl/client/ca/ca.crt
        - --insecure-transport=false
        - --insecure-skip-tls-verify=false
        - --endpoints=https://{{ .Values.name }}-0:2379
        - --etcd-connection-timeout=300s
        - --delta-snapshot-period=300s
        image: {{ index .Values.images "etcd-backup-restore" }}
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
          name: server
          protocol: TCP
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 300m
            memory: 1Gi
        env:
        - name: STORAGE_CONTAINER
          value: {{ .Values.backup.storageContainer }}
        - name: POD_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace
{{- if .Values.backup.env }}
{{ toYaml .Values.backup.env | indent 8 }}
{{- end }}
        volumeMounts:
        - name: {{ .Values.name }}
          mountPath: /var/etcd/data
        - name: etcd-bootstrap
          mountPath: /var/etcd/config
        - name: client-url-ca-etcd
          mountPath: /var/etcd/ssl/client/ca
        - name: client-url-etcd-client-tls
          mountPath: /var/etcd/ssl/client/client
{{- if .Values.backup.volumeMounts }}
{{ toYaml .Values.backup.volumeMounts | indent 8 }}
{{- end }}
      volumes:
      - name: etcd-bootstrap
        configMap:
          name: {{ .Values.name }}-bootstrap
          defaultMode: 356
      - name: client-url-etcd-server-tls
        secret:
          secretName: {{ .Values.name }}-server
      - name: client-url-etcd-client-tls
        secret:
          secretName: {{ .Values.name }}-client
      - name: client-url-ca-etcd
        secret:
          secretName: {{ .Values.name }}-ca
{{- if .Values.backup.storageProvider }}
      - name: etcd-backup
        secret:
          secretName: {{ .Values.name }}-backup
{{- if .Values.backup.secretItems }}
{{ toYaml .Values.backup.secretItems | indent 10 }}
{{- end}}
{{- end }}
  volumeClaimTemplates:
  - metadata:
      name: {{ .Values.name }}
    spec:
      accessModes:
      - "ReadWriteOnce"
      resources:
        requests:
          storage: {{ .Values.volumeClaimTemplates.requests.storage }}
